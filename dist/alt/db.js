alt.loader.db=function(){return"undefined"!=typeof alt.modules.db?alt.modules.db:(alt.modules.db=angular.module("alt-db",[]).factory("$db",["$log","$q","$api","$interval","$auth",function(e,t,a,n,c){var s=function(e,a){var n={lf:lf};s.connection=null,n.schema=a||{},n.tablename=(e+"").split("/").join("_");var r=s.schema_builder.createTable(n.tablename);return n.schema.fields=n.schema.fields||[],angular.forEach(n.schema.fields,function(e,t){r.addColumn(t,e),(!n.schema.pkey||n.schema.pkey&&t!=n.schema.pkey)&&r.addNullable([t])}),n.schema.pkey&&(n.schema.pkey="object"==typeof n.schema.pkey?n.schema.pkey:[n.schema.pkey],r.addPrimaryKey(n.schema.pkey,n.schema.autoinc)),n.schema.index=n.schema.index||[],angular.forEach(n.schema.index,function(e){r.addIndex(e.id,e.fields,!1,e.order)}),n.parser=function(e,t){e=e||{};var a={fields:[],where:[],order:[],limit:null,offset:null};return angular.forEach(e,function(n,c){switch((c+"").toLowerCase()){case"select":var s=(e.select+"").split(",");angular.forEach(s,function(e,n){e=e.trim(),t[e]&&a.fields.push(t[e])});break;case"where":switch(typeof e.where){case"string":var s=e.where.split(" "),c=s[0]+"",r=s[1]+"",i=(s[2]+"").split("'").join("");switch(r.toLowerCase()){case"=":r="eq";break;case"<>":r="neq";break;case">":r="gt";break;case"<":r="lt";break;case">=":r="gte";break;case"<=":r="lte";break;case"in":r="in";break;case"like":default:r="match",i=new RegExp(i,"i")}t[c]&&a.where.push(t[c][r](i));break;case"object":angular.forEach(e.where,function(e,n){var c=e.split(" "),n=c[0]+"",s=c[1]+"",r=(c[2]+"").split("'").join("");switch(s.toLowerCase()){case"=":s="eq";break;case"<>":s="neq";break;case">":s="gt";break;case"<":s="lt";break;case">=":s="gte";break;case"<=":s="lte";break;case"in":s="in";break;case"like":default:s="match",r=new RegExp(r,"i")}t[n]&&a.where.push(t[n][s](r))})}break;case"limit":a.limit=parseInt(e.limit);break;case"offset":a.offset=parseInt(e.offset);break;case"order":var s=(e.order+"").split(",");angular.forEach(s,function(e,n){var c=((e+"").split(" "),e[0]),s=e[1].toLowerCase();t[c]&&a.order.push([t[c],"desc"==s?lf.Order.DESC:lf.Order.ASC])});break;default:if(t[c]){s=(n+"").split(" ");var r=s.length>1&&["=","<>",">","<",">=","<=","in","like"].indexOf(s[0])>-1?s[0]:"like",i=(s.length>1?(s[1]+"").split("'").join(""):s[0])+"";switch(r.toLowerCase()){case"=":r="eq";break;case"<>":r="neq";break;case">":r="gt";break;case"<":r="lt";break;case">=":r="gte";break;case"<=":r="lte";break;case"in":r="in";break;case"like":default:r="match",i=new RegExp(i,"i")}a.where.push(t[c][r](i))}}}),0==a.fields.length&&delete a.fields,0==a.order.length&&delete a.order,null==a.limit&&delete a.limit,null==a.offset&&delete a.offset,0==a.where.length?delete a.where:a.where=a.where.length>1?lf.op.and.apply(s.connection,a.where):a.where[0],a},n.count=function(e){e=e||{};var a=t.defer();return s.connect().then(function(){var t,a=s.connection.getSchema().table(n.tablename),c=n.parser(e,a);return t=s.connection.select(lf.fn.count().as("numofrow")),t.from(a),c.where&&t.where(c.where),t.exec()}).then(function(e){a.resolve({status:200,data:e&&e.length>0?e[0].numofrow:0})})["catch"](function(e){a.reject({status:e.code,message:e.message})}),a.promise},n.list=function(e){e=e||{};var a=t.defer();return s.connect().then(function(){var t,a=s.connection.getSchema().table(n.tablename),c=n.parser(e,a);return t=c.fields?s.connection.select.apply(s.connection,c.fields):s.connection.select(),t.from(a),c.where&&t.where(c.where),c.limit&&t.limit(c.limit),c.offset&&t.skip(c.offset),c.order&&angular.forEach(c.order,function(e){t=t.orderBy.apply(s.connection,e)}),t.exec()}).then(function(e){a.resolve({status:200,data:e})})["catch"](function(e){a.reject({status:e.code,message:e.message})}),a.promise},n.keyvalues=function(e){e=e||{};var a=t.defer(),c={status:200,data:{}};return n.list(e).then(function(t){e.key=e.key||n.schema.pkey,angular.forEach(t.data,function(t,a){c.data[t[e.key]]=e.values&&t[e.values]?t[e.values]:t}),a.resolve(c)})["catch"](function(e){a.reject({status:e.code,message:e.message})}),a.promise},n.table=function(e){e=e||{};var a=t.defer(),c={status:200,data:{}};return n.count(e).then(function(t){return c.data.total=t.data,n.list(e)}).then(function(e){c.data.list=e.data,a.resolve(c)})["catch"](function(e){a.reject({status:e.code,message:e.message})}),a.promise},n.insert=function(e){e=e||{};var a=t.defer();return s.connect().then(function(){"undefined"!=typeof n.schema.fields.entrytime&&(e.entrytime=new Date),"undefined"!=typeof n.schema.fields.entryuser&&(e.entryuser=c.userdata.username);var t=s.connection.getSchema().table(n.tablename),a=t.createRow(e);return s.connection.insert().into(t).values([a]).exec()}).then(function(e){a.resolve({status:200,data:e[0][n.schema.pkey]})})["catch"](function(e){a.reject({status:e.code,message:e.message})}),a.promise},n.update=function(e){e=e||{};var a=t.defer();return s.connect().then(function(){"undefined"!=typeof n.schema.fields.modifiedtime&&(e.modifiedtime=new Date),"undefined"!=typeof n.schema.fields.modifieduser&&(e.modifieduser=c.userdata.username);var t,a=s.connection.getSchema().table(n.tablename),r=n.parser({where:e.where||""},a);return t=s.connection.update(a),angular.forEach(e,function(e,n){a[n]&&t.set(a[n],e)}),r.where?t.where(r.where):e[n.schema.pkey]&&t.where(a[n.schema.pkey].eq(e[n.schema.pkey])),t.exec()}).then(function(e){a.resolve({status:200,data:1})})["catch"](function(e){a.reject({status:e.code,message:e.message})}),a.promise},n.retrieve=function(e){e=e||{},e.limit=1,e[n.schema.pkey]&&(e[n.schema.pkey]=0==(e[n.schema.pkey]+"").indexOf("=")?e[n.schema.pkey]:"= "+e[n.schema.pkey]);var a=t.defer();return n.list(e).then(function(e){if(e.data.length<=0)throw new Error("Data tidak ditemukan!",500);e.data=e.data[0],a.resolve(e)})["catch"](function(e){a.reject({status:e.code||500,message:e.message})}),a.promise},n.remove=function(e){e=e||{},e[n.schema.pkey]&&(e[n.schema.pkey]=0==(e[n.schema.pkey]+"").indexOf("=")?e[n.schema.pkey]:"= "+e[n.schema.pkey]);var a=t.defer();return s.connect().then(function(){"undefined"!=typeof n.schema.fields.deletedtime&&(e.deletedtime=new Date),"undefined"!=typeof n.schema.fields.deleteduser&&(e.deleteduser=c.userdata.username),"undefined"!=typeof n.schema.fields.isdeleted&&(e.isdeleted=!0);var t,a=s.connection.getSchema().table(n.tablename),r=n.parser(e,a);return t=n.schema.fields.isdeleted?s.connection.update(a):s.connection["delete"]().from(a),r.where?t.where(r.where):e[n.schema.pkey]&&t.where(a[n.schema.pkey].eq(e[n.schema.pkey])),t.exec()}).then(function(e){a.resolve({status:200,data:1})})["catch"](function(e){a.reject({status:e.code,message:e.message})}),a.promise},n.isexist=function(e){e=e||{};var a=t.defer();return n.count(e).then(function(e){e.data=e.data||0,a.resolve()})["catch"](function(e){a.reject({status:e.code,message:e.message})}),a.promise},n};return s.schema_builder=lf.schema.create(alt.application,+new Date/1e3),s.isconnecting=!1,s.connection=null,s.connect=function(){var e=t.defer();if(null!==s.connection)s.isconnecting=!1,e.resolve(s.connection);else if(s.isconnecting)var a=n(function(){s.connection&&(n.cancel(a),s.isconnecting=!1,e.resolve(s.connection))},100);else s.isconnecting=!0,s.schema_builder.connect().then(function(t){s.isconnecting=!1,s.connection=t,e.resolve(s.connection)});return e.promise},s.NUMBER=lf.Type.NUMBER,s.INTEGER=lf.Type.INTEGER,s.STRING=lf.Type.STRING,s.DATE_TIME=lf.Type.DATE_TIME,s.BOOLEAN=lf.Type.BOOLEAN,s.ARRAY_BUFFER=lf.Type.ARRAY_BUFFER,s.OBJECT=lf.Type.OBJECT,s.ASC=lf.Order.ASC,s.DESC=lf.Order.DESC,s}]),void alt.module("alt-db",alt.modules.db))},"undefined"!=typeof define?define([],function(){alt.loader.db()}):alt.loader.db();