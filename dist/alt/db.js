alt.loader.db=function(){return"undefined"!=typeof alt.modules.db?alt.modules.db:(alt.modules.db=angular.module("alt-db",[]).factory("$db",["$log","$q","$api","$interval","$auth","$uuid",function(e,t,a,n,c,s){var r=function(e,a){var n={lf:lf};r.connection=null,n.schema=a||{},n.tablename=(e+"").split("/").join("_");var i=r.schema_builder.createTable(n.tablename);return n.schema.fields=n.schema.fields||[],angular.forEach(n.schema.fields,function(e,t){i.addColumn(t,e),(!n.schema.pkey||n.schema.pkey&&t!=n.schema.pkey)&&i.addNullable([t])}),n.schema.pkey&&i.addPrimaryKey("object"==typeof n.schema.pkey?n.schema.pkey:[n.schema.pkey],n.schema.autoinc),n.schema.index=n.schema.index||[],angular.forEach(n.schema.index,function(e){i.addIndex(e.id,e.fields,!1,e.order)}),n.parser=function(e,t){var a=angular.copy(e||{}),n={fields:[],where:[],order:[],limit:null,offset:null};return angular.forEach(a,function(e,c){switch((c+"").toLowerCase()){case"select":var s=(a.select+"").split(",");angular.forEach(s,function(e,a){e=e.trim(),t[e]&&n.fields.push(t[e])});break;case"where":switch(typeof a.where){case"string":var s=a.where.split(" "),c=s[0]+"",r=s[1]+"",i=(s[2]+"").split("'").join("");switch(r.toLowerCase()){case"=":r="eq";break;case"<>":r="neq";break;case">":r="gt";break;case"<":r="lt";break;case">=":r="gte";break;case"<=":r="lte";break;case"in":r="in";break;case"like":default:r="match",i=new RegExp(i,"i")}t[c]&&n.where.push(t[c][r](i));break;case"object":angular.forEach(a.where,function(e,a){var c=e.split(" "),a=c[0]+"",s=c[1]+"",r=(c[2]+"").split("'").join("");switch(s.toLowerCase()){case"=":s="eq";break;case"<>":s="neq";break;case">":s="gt";break;case"<":s="lt";break;case">=":s="gte";break;case"<=":s="lte";break;case"in":s="in";break;case"like":default:s="match",r=new RegExp(r,"i")}t[a]&&n.where.push(t[a][s](r))})}break;case"limit":n.limit=parseInt(a.limit);break;case"offset":n.offset=parseInt(a.offset);break;case"order":var s=(a.order+"").split(",");angular.forEach(s,function(e,a){var c=((e+"").split(" "),e[0]),s=(e[1]+"").toLowerCase();t[c]&&n.order.push([t[c],"desc"==s?lf.Order.DESC:lf.Order.ASC])});break;default:if(t[c]){s=(e+"").split(" ");var r=s.length>1&&["=","<>",">","<",">=","<=","in","like"].indexOf(s[0])>-1?s[0]:"like",i=(s.length>1?(s[1]+"").split("'").join(""):s[0])+"";switch(r.toLowerCase()){case"=":r="eq";break;case"<>":r="neq";break;case">":r="gt";break;case"<":r="lt";break;case">=":r="gte";break;case"<=":r="lte";break;case"in":r="in";break;case"like":default:r="match",i=new RegExp(i,"i")}n.where.push(t[c][r](i))}}}),0==n.fields.length&&delete n.fields,0==n.order.length&&delete n.order,null==n.limit&&delete n.limit,null==n.offset&&delete n.offset,0==n.where.length?delete n.where:n.where=n.where.length>1?lf.op.and.apply(r.connection,n.where):n.where[0],n},n.count=function(e){var a=angular.copy(e||{}),c=t.defer();return r.connect().then(function(){var e,t=r.connection.getSchema().table(n.tablename),c=n.parser(a,t);return e=r.connection.select(lf.fn.count().as("numofrow")),e.from(t),c.where&&e.where(c.where),e.exec()}).then(function(e){c.resolve({status:200,data:e&&e.length>0?e[0].numofrow:0})})["catch"](function(e){c.reject({status:e.code,message:e.message})}),c.promise},n.list=function(e){var a=angular.copy(e||{});"undefined"!=typeof n.schema.fields.isdeleted&&(a.isdeleted=a.isdeleted||!1);var c=t.defer();return r.connect().then(function(){var e,t=r.connection.getSchema().table(n.tablename),c=n.parser(a,t);return e=c.fields?r.connection.select.apply(r.connection,c.fields):r.connection.select(),e.from(t),c.where&&e.where(c.where),c.limit&&e.limit(c.limit),c.offset&&e.skip(c.offset),c.order&&angular.forEach(c.order,function(t){e=e.orderBy.apply(r.connection,t)}),e.exec()}).then(function(e){c.resolve({status:200,data:e})})["catch"](function(e){c.reject({status:e.code,message:e.message})}),c.promise},n.keyvalues=function(e){var a=angular.copy(e||{}),c=t.defer(),s={status:200,data:{}};return n.list(a).then(function(e){a.key=a.key||n.schema.pkey,angular.forEach(e.data,function(e,t){s.data[e[a.key]]=a.values&&e[a.values]?e[a.values]:e}),c.resolve(s)})["catch"](function(e){c.reject({status:e.code,message:e.message})}),c.promise},n.table=function(e){var a=angular.copy(e||{}),c=t.defer(),s={status:200,data:{}};return n.count(a).then(function(e){return s.data.total=e.data,n.list(a)}).then(function(e){s.data.list=e.data,c.resolve(s)})["catch"](function(e){c.reject({status:e.code,message:e.message})}),c.promise},n.insert=function(e){var a=angular.copy(e||{}),i=t.defer();return r.connect().then(function(){"undefined"==typeof n.schema.pkey||n.schema.autoinc||"undefined"!=typeof a[n.schema.pkey]||(a[n.schema.pkey]=s.create()),"undefined"!=typeof n.schema.fields.isdeleted&&"undefined"==typeof a.isdeleted&&(a.isdeleted=!1),"undefined"!=typeof n.schema.fields.entrytime&&(a.entrytime=new Date),"undefined"!=typeof n.schema.fields.entryuser&&(a.entryuser=c.userdata.username);var e=r.connection.getSchema().table(n.tablename),t=e.createRow(a);return r.connection.insert().into(e).values([t]).exec()}).then(function(e){i.resolve({status:200,data:e[0][n.schema.pkey]})})["catch"](function(e){i.reject({status:e.code,message:e.message})}),i.promise},n.update=function(e){var a=angular.copy(e||{}),s=t.defer();return r.connect().then(function(){"undefined"!=typeof n.schema.fields.modifiedtime&&(a.modifiedtime=new Date),"undefined"!=typeof n.schema.fields.modifieduser&&(a.modifieduser=c.userdata.username);var e,t=r.connection.getSchema().table(n.tablename),s=n.parser({where:a.where||""},t);return e=r.connection.update(t),angular.forEach(a,function(a,n){t[n]&&e.set(t[n],a)}),s.where?e.where(s.where):a[n.schema.pkey]&&e.where(t[n.schema.pkey].eq(a[n.schema.pkey])),e.exec()}).then(function(e){s.resolve({status:200,data:1})})["catch"](function(e){s.reject({status:e.code,message:e.message})}),s.promise},n.retrieve=function(e){var a=angular.copy(e||{});a.limit=1,a[n.schema.pkey]&&(a[n.schema.pkey]=0==(a[n.schema.pkey]+"").indexOf("=")?a[n.schema.pkey]:"= "+a[n.schema.pkey]);var c=t.defer();return n.list(a).then(function(e){if(e.data.length<=0)throw new Error("Data tidak ditemukan!",500);e.data=e.data[0],c.resolve(e)})["catch"](function(e){c.reject({status:e.code||500,message:e.message})}),c.promise},n.remove=function(e){var a=angular.copy(e||{});"undefined"!=typeof n.schema.pkey&&"undefined"!=typeof a[n.schema.pkey]&&(a[n.schema.pkey]=0==(a[n.schema.pkey]+"").indexOf("=")?a[n.schema.pkey]:"= "+a[n.schema.pkey]);var s=t.defer();return r.connect().then(function(){var e,t=r.connection.getSchema().table(n.tablename),s=n.parser(a,t);return"undefined"!=typeof n.schema.fields.deletedtime&&(a.deletedtime=new Date),"undefined"!=typeof n.schema.fields.deleteduser&&(a.deleteduser=c.userdata.username),"undefined"!=typeof n.schema.fields.isdeleted&&(a.isdeleted=!0),e=n.schema.fields.isdeleted?r.connection.update(t):r.connection["delete"]().from(t),s.where?e.where(s.where):a[n.schema.pkey]&&e.where(t[n.schema.pkey].eq(a[n.schema.pkey])),e.exec()}).then(function(e){s.resolve({status:200,data:1})})["catch"](function(e){s.reject({status:e.code,message:e.message})}),s.promise},n.isexist=function(e){var a=angular.copy(e||{}),c=t.defer();return n.count(a).then(function(e){e.data=e.data||0,c.resolve()})["catch"](function(e){c.reject({status:e.code,message:e.message})}),c.promise},n};return r.schema_builder=lf.schema.create(alt.application,+new Date/1e3),r.isconnecting=!1,r.connection=null,r.connect=function(){var e=t.defer();if(null!==r.connection)r.isconnecting=!1,e.resolve(r.connection);else if(r.isconnecting)var a=n(function(){r.connection&&(n.cancel(a),r.isconnecting=!1,e.resolve(r.connection))},100);else r.isconnecting=!0,r.schema_builder.connect().then(function(t){r.isconnecting=!1,r.connection=t,e.resolve(r.connection)});return e.promise},r.NUMBER=lf.Type.NUMBER,r.INTEGER=lf.Type.INTEGER,r.STRING=lf.Type.STRING,r.DATE_TIME=lf.Type.DATE_TIME,r.BOOLEAN=lf.Type.BOOLEAN,r.ARRAY_BUFFER=lf.Type.ARRAY_BUFFER,r.OBJECT=lf.Type.OBJECT,r.ASC=lf.Order.ASC,r.DESC=lf.Order.DESC,r}]),void alt.module("alt-db",alt.modules.db))},"undefined"!=typeof define?define([],function(){alt.loader.db()}):alt.loader.db();